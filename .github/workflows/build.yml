name: Build AIX Extension

on:
  workflow_dispatch:
    inputs:
      java_code:
        description: 'Base64 encoded Java file content'
        required: true
      project_name:
        description: 'Name of the project'
        required: true
      package_name:
        description: 'Package name'
        required: true
      use_androidx:
        description: 'Enable AndroidX support'
        required: false
        default: 'false'
      use_proguard:
        description: 'Enable Proguard'
        required: false
        default: 'false'
      proguard_rules:
        description: 'Base64 encoded Proguard rules'
        required: false
      libraries:
        description: 'JSON string of libraries to include'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up JDK 1.8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Install Fast CLI
      run: |
        # Get the latest release download URL
        LATEST_URL=$(curl -s https://api.github.com/repos/jewelshkjony/fast-cli/releases/latest | grep "browser_download_url.*fast.zip" | cut -d '"' -f 4)
        echo "Downloading Fast CLI from: $LATEST_URL"
        wget $LATEST_URL -O fast.zip
        unzip fast.zip
        
        # Create a wrapper script to run the jar
        echo '#!/bin/bash' > fast
        echo 'java -jar /usr/local/bin/fast.jar "$@"' >> fast
        chmod +x fast
        
        # Move files to system path
        sudo mv fast.jar /usr/local/bin/fast.jar
        sudo mv fast /usr/local/bin/fast
        
        # Move the lib folder which is required by fast.jar
        sudo mv lib /usr/local/bin/lib
        
        fast --version

    - name: Prepare Project Structure
      run: |
        mkdir -p src
        mkdir -p assets
        # Note: We are using sanitized code that expects assets at the root, not in images/
        
        echo "${{ inputs.java_code }}" | base64 --decode > src/${{ inputs.project_name }}.java
        
        # Handle Proguard Rules
        if [ "${{ inputs.use_proguard }}" = "true" ] && [ -n "${{ inputs.proguard_rules }}" ]; then
           echo "Adding Proguard Rules..."
           echo "${{ inputs.proguard_rules }}" | base64 --decode > proguard-rules.pro
        fi

        # Handle Libraries (Jars)
        if [ -n "${{ inputs.libraries }}" ]; then
           echo "Processing libraries..."
           mkdir -p deps
           # We use a python one-liner to parse the JSON and save files because jq might be complex with base64
           echo '${{ inputs.libraries }}' > libs.json
           python3 -c "
import json
import base64
import os

with open('libs.json', 'r') as f:
    data = json.load(f)

for lib in data:
    name = lib['name']
    content = lib['content']
    print(f'Decoding library: {name}')
    with open(f'deps/{name}', 'wb') as f_out:
        f_out.write(base64.b64decode(content))
"
        fi
        
        # Create minimal AndroidManifest.xml
        cat > src/AndroidManifest.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="${{ inputs.package_name }}">
            <application>
            </application>
        </manifest>
        EOF
        
        # Create extension.png directly in assets folder (No subdirectories)
        ICON_BASE64="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
        echo "$ICON_BASE64" | base64 --decode > assets/extension.png
        
        # Create fast.yml configuration
        # We build the YAML dynamically based on inputs
        echo "name: ${{ inputs.project_name }}" > fast.yml
        echo "package: ${{ inputs.package_name }}" >> fast.yml
        echo "version: 1" >> fast.yml
        
        if [ "${{ inputs.use_androidx }}" = "true" ]; then
           echo "desugar: true" >> fast.yml
        fi
        
        if [ "${{ inputs.use_proguard }}" = "true" ]; then
           echo "minify: true" >> fast.yml
           echo "proguard: proguard-rules.pro" >> fast.yml
        fi
        
        # Add assets
        echo "assets:" >> fast.yml
        echo "  - extension.png" >> fast.yml

        # Add libraries if present
        if [ -n "${{ inputs.libraries }}" ]; then
           echo "libraries:" >> fast.yml
           for lib in deps/*.jar; do
              [ -e "$lib" ] || continue
              echo "  - $lib" >> fast.yml
           done
        fi
        
        echo "Generated fast.yml:"
        cat fast.yml

    - name: Build Extension
      run: |
        fast build
        ls -la out/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.project_name }}-extension
        path: out/*.aix
