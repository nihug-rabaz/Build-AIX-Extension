name: Build AIX Extension

on:
  workflow_dispatch:
    inputs:
      java_code:
        description: 'Base64 encoded Java file content'
        required: true
      project_name:
        description: 'Name of the project'
        required: true
      package_name:
        description: 'Package name'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up JDK 1.8
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Install Fast CLI
      run: |
        # Get the latest release download URL
        LATEST_URL=$(curl -s https://api.github.com/repos/jewelshkjony/fast-cli/releases/latest | grep "browser_download_url.*fast.zip" | cut -d '"' -f 4)
        echo "Downloading Fast CLI from: $LATEST_URL"
        wget $LATEST_URL -O fast.zip
        unzip fast.zip
        
        # Create a wrapper script to run the jar
        echo '#!/bin/bash' > fast
        echo 'java -jar /usr/local/bin/fast.jar "$@"' >> fast
        chmod +x fast
        
        # Move files to system path
        sudo mv fast.jar /usr/local/bin/fast.jar
        sudo mv fast /usr/local/bin/fast
        
        # Move the lib folder which is required by fast.jar
        sudo mv lib /usr/local/bin/lib
        
        fast --version

    - name: Prepare Project Structure
      run: |
        mkdir -p src
        mkdir -p assets
        # Note: We are using sanitized code that expects assets at the root, not in images/
        
        echo "${{ inputs.java_code }}" | base64 --decode > src/${{ inputs.project_name }}.java
        
        # Create minimal AndroidManifest.xml
        cat > src/AndroidManifest.xml << EOF
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="${{ inputs.package_name }}">
            <application>
            </application>
        </manifest>
        EOF
        
        # Create extension.png directly in assets folder (No subdirectories)
        ICON_BASE64="iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
        echo "$ICON_BASE64" | base64 --decode > assets/extension.png
        
        # Create fast.yml configuration
        cat > fast.yml << EOF
        name: ${{ inputs.project_name }}
        package: ${{ inputs.package_name }}
        version: 1
        assets:
          - extension.png
        EOF

    - name: Build Extension
      run: |
        fast build
        ls -la out/

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.project_name }}-extension
        path: out/*.aix
